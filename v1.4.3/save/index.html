<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Saving Tools · DrWatson</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link href="../assets/documenter.css" rel="stylesheet" type="text/css"/><link href="../assets/logo.ico" rel="icon" type="image/x-icon"/></head><body><nav class="toc"><a href="../"><img class="logo" src="../assets/logo.png" alt="DrWatson logo"/></a><h1>DrWatson</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../">Introduction</a></li><li><a class="toctext" href="../project/">Project Setup</a></li><li><a class="toctext" href="../name/">Naming Simulations</a></li><li class="current"><a class="toctext" href>Saving Tools</a><ul class="internal"><li><a class="toctext" href="#Converting-a-struct-to-a-dictionary-1">Converting a struct to a dictionary</a></li><li><a class="toctext" href="#Safely-saving-data-1">Safely saving data</a></li><li><a class="toctext" href="#Tagging-a-run-using-Git-1">Tagging a run using Git</a></li><li><a class="toctext" href="#Produce-or-Load-1">Produce or Load</a></li></ul></li><li><a class="toctext" href="../run&amp;list/">Running &amp; Listing Simulations</a></li><li><a class="toctext" href="../real_world/">Real World Examples</a></li></ul></nav><article id="docs"><header><nav><ul><li><a href>Saving Tools</a></li></ul><a class="edit-page" href="https://github.com/JuliaDynamics/DrWatson.jl/blob/master/docs/src/save.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Saving Tools</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Saving-Tools-1" href="#Saving-Tools-1">Saving Tools</a></h1><p>This page discusses numerous tools that can significantly improve process of saving &amp; loading files, always in a scientific context.</p><p>These tools are also used in the examples demonstrated in the <a href="../real_world/#Real-World-Examples-1">Real World Examples</a> page. After reading the proper documentation here it might be worth it to have a look there as well!</p><div class="admonition warning"><div class="admonition-title">We use `FileIO`</div><div class="admonition-text"><p>For saving and loading files we use <code>FileIO.save</code> and <code>FileIO.load</code>. This means that you have to install yourself whatever saving backend you want to use. <code>FileIO</code> by itself does <em>not</em> install a package that saves data, it only provides the interface!</p><p>The <em>suffix</em> of the file name determines which package will be used for actually saving the file. It is <strong>your responsibility</strong> to know how the saving package works and what input it expects!</p></div></div><div class="admonition info"><div class="admonition-title">We always call `mkpath`</div><div class="admonition-text"><p>All functions of DrWatson that save things, e.g. <a href="#DrWatson.tagsave"><code>tagsave</code></a>, <a href="#DrWatson.safesave"><code>safesave</code></a>, <a href="../run&amp;list/#DrWatson.tmpsave"><code>tmpsave</code></a> etc. always call <code>mkpath</code> first on the directory the file needs to be saved at. This is not the case for the standard <code>save</code> function, as it comes from <code>FileIO</code>.</p></div></div><h2><a class="nav-anchor" id="Converting-a-struct-to-a-dictionary-1" href="#Converting-a-struct-to-a-dictionary-1">Converting a struct to a dictionary</a></h2><p><a href="../name/#DrWatson.savename"><code>savename</code></a> gives great support for getting a name out of any Julia composite type. To save something though, one needs a dictionary. So the following function can be conveniently used to directly save a struct using any saving function:</p><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DrWatson.struct2dict" href="#DrWatson.struct2dict"><code>DrWatson.struct2dict</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">struct2dict(s) -&gt; d</code></pre><p>Convert a Julia composite type <code>s</code> to a dictionary <code>d</code> with key type <code>Symbol</code> that maps each field of <code>s</code> to its value. This can be useful in e.g. saving:</p><pre><code class="language-none">tagsave(savename(s), struct2dict(s))</code></pre></div></div><a class="source-link" target="_blank" href="https://github.com/JuliaDynamics/DrWatson.jl/blob/5693e6caa22fad1d0193ea560b33b1cabef2d8a4/src/saving_tools.jl#L287-L294">source</a></section><h2><a class="nav-anchor" id="Safely-saving-data-1" href="#Safely-saving-data-1">Safely saving data</a></h2><p>Almost all packages that save data by default overwrite existing files (if given a save name of an existing file). This is the default behavior because often it is desired.</p><p>Sometimes it is not though! And the consequences of overwritten data can range from irrelevant to catastrophic. To avoid such an event we provide an alternative way to save data that will never overwrite existing files:</p><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DrWatson.safesave" href="#DrWatson.safesave"><code>DrWatson.safesave</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">safesave(filename, data)</code></pre><p>Safely save <code>data</code> in <code>filename</code> by ensuring that no existing files are overwritten. Do this by renaming already existing data with a backup-number ending like <code>#1, #2, ...</code>. For example if <code>filename = test.bson</code>, the first time you <code>safesave</code> it, the file is saved normally. The second time the existing save is renamed to <code>test_#1.bson</code> and a new file <code>test.bson</code> is then saved.</p><p>If a backup file already exists then its backup-number is incremented (e.g. going from <code>#2</code> to <code>#3</code>). For example safesaving <code>test.bson</code> a third time will rename the old <code>test_#1.bson</code> to <code>test_#2.bson</code>, rename the old <code>test.bson</code> to <code>test_#1.bson</code> and then save a new <code>test.bson</code> with the latest <code>data</code>.</p><p>See also <a href="#DrWatson.tagsave"><code>tagsave</code></a>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/JuliaDynamics/DrWatson.jl/blob/5693e6caa22fad1d0193ea560b33b1cabef2d8a4/src/saving_files.jl#L126-L143">source</a></section><h2><a class="nav-anchor" id="Tagging-a-run-using-Git-1" href="#Tagging-a-run-using-Git-1">Tagging a run using Git</a></h2><p>For reproducibility reasons (and also to not go insane when asking &quot;HOW DID I GET THOSE RESUUUULTS&quot;) it is useful to &quot;tag&quot; any simulation/result/process using the Git status of the repository.</p><p>To this end we have some functions that can be used to ensure reproducibility:</p><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DrWatson.tagsave" href="#DrWatson.tagsave"><code>DrWatson.tagsave</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">tagsave(file::String, d::Dict; safe = false, gitpath = projectdir(), storepatch = true, force = false)</code></pre><p>First <a href="#DrWatson.tag!"><code>tag!</code></a> dictionary <code>d</code> and then save <code>d</code> in <code>file</code>. If <code>safe = true</code> save the file using <a href="#DrWatson.safesave"><code>safesave</code></a>.</p><p>&quot;Tagging&quot; means that when saving the dictionary, an extra field <code>:gitcommit</code> is added to establish reproducibility of results using Git. If the Git repository is dirty, one more field <code>:gitpatch</code> is added that stores the difference string.  If a dictionary already contains a key <code>:gitcommit</code>, it is not overwritten, unless, <code>force=true</code>. For more details, see <a href="#DrWatson.tag!"><code>tag!</code></a>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/JuliaDynamics/DrWatson.jl/blob/5693e6caa22fad1d0193ea560b33b1cabef2d8a4/src/saving_files.jl#L74-L85">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DrWatson.@tagsave" href="#DrWatson.@tagsave"><code>DrWatson.@tagsave</code></a> — <span class="docstring-category">Macro</span>.</div><div><div><pre><code class="language-julia">@tagsave(file::String, d::Dict; safe = false, gitpath = projectdir(), force = false)</code></pre><p>Same as <a href="#DrWatson.tagsave"><code>tagsave</code></a> but one more field <code>:script</code> is added that records the local path of the script and line number that called <code>@tagsave</code>, see <a href="#DrWatson.@tag!"><code>@tag!</code></a>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/JuliaDynamics/DrWatson.jl/blob/5693e6caa22fad1d0193ea560b33b1cabef2d8a4/src/saving_files.jl#L98-L102">source</a></section><p>The functions also incorporate <a href="#DrWatson.safesave"><code>safesave</code></a> if need be.</p><h3><a class="nav-anchor" id="Low-level-functions-1" href="#Low-level-functions-1">Low level functions</a></h3><p><a href="#DrWatson.@tagsave"><code>@tagsave</code></a> internally uses the following low level functions:</p><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DrWatson.tag!" href="#DrWatson.tag!"><code>DrWatson.tag!</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">tag!(d::Dict; gitpath = projectdir(), storepatch = true, force = false) -&gt; d</code></pre><p>Tag <code>d</code> by adding an extra field <code>gitcommit</code> which will have as value the <a href="#DrWatson.gitdescribe"><code>gitdescribe</code></a> of the repository at <code>gitpath</code> (by default the project&#39;s gitpath). Do nothing if a key <code>gitcommit</code> already exists (unless <code>force=true</code> then replace with the new value) or if the Git repository is not found. If the git repository is dirty, i.e. there are un-commited changes, then the output of <code>git diff HEAD</code> is stored in the field <code>gitpatch</code>.  Note that patches for binary files are not stored.</p><p>Notice that if <code>String</code> is not a subtype of the value type of <code>d</code> then a new dictionary is created and returned. Otherwise the operation is inplace (and the dictionary is returned again).</p><p>To restore a repository to the state of a particular model-run do:</p><ol><li>checkout the relevant commit with <code>git checkout xyz</code> where xyz is the value stored</li><li>apply the patch <code>git apply patch</code>, where the string stored in the <code>gitpatch</code> field needs to be written to the file <code>patch</code>.</li></ol><p><strong>Examples</strong></p><pre><code class="language-julia">julia&gt; d = Dict(:x =&gt; 3, :y =&gt; 4)
Dict{Symbol,Int64} with 2 entries:
  :y =&gt; 4
  :x =&gt; 3

julia&gt; tag!(d)
Dict{Symbol,Any} with 3 entries:
  :y =&gt; 4
  :gitcommit =&gt; &quot;96df587e45b29e7a46348a3d780db1f85f41de04&quot;
  :x =&gt; 3</code></pre></div></div><a class="source-link" target="_blank" href="https://github.com/JuliaDynamics/DrWatson.jl/blob/5693e6caa22fad1d0193ea560b33b1cabef2d8a4/src/saving_tools.jl#L98-L130">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DrWatson.@tag!" href="#DrWatson.@tag!"><code>DrWatson.@tag!</code></a> — <span class="docstring-category">Macro</span>.</div><div><div><pre><code class="language-julia">@tag!(d, gitpath = projectdir(), storepatch = true, force = false) -&gt; d</code></pre><p>Do the same as <a href="#DrWatson.tag!"><code>tag!</code></a> but also add another field <code>script</code> that has the path of the script that called <code>@tag!</code>, relative with respect to <code>gitpath</code>. The saved string ends with <code>#line_number</code>, which indicates the line number within the script that <code>@tag!</code> was called at.</p><p><strong>Examples</strong></p><pre><code class="language-julia">julia&gt; d = Dict(:x =&gt; 3)Dict{Symbol,Int64} with 1 entry:
  :x =&gt; 3

julia&gt; @tag!(d) # running from a script or inline evaluation of Juno
Dict{Symbol,Any} with 3 entries:
  :gitcommit =&gt; &quot;618b72bc0936404ab6a4dd8d15385868b8299d68&quot;
  :script =&gt; &quot;test\stools_tests.jl#10&quot;
  :x      =&gt; 3</code></pre></div></div><a class="source-link" target="_blank" href="https://github.com/JuliaDynamics/DrWatson.jl/blob/5693e6caa22fad1d0193ea560b33b1cabef2d8a4/src/saving_tools.jl#L173-L191">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DrWatson.gitdescribe" href="#DrWatson.gitdescribe"><code>DrWatson.gitdescribe</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">gitdescribe(gitpath = projectdir()) -&gt; gitstr</code></pre><p>Return a string <code>gitstr</code> with the output of <code>git describe</code> if an annotated git tag exists, otherwise the current active commit id of the Git repository present in <code>gitpath</code>, which by default is the currently active project. If the repository is dirty when this function is called the string will end with <code>&quot;_dirty&quot;</code>.</p><p>Return <code>nothing</code> if <code>gitpath</code> is not a Git repository, i.e. a directory within a git repository.</p><p>The format of the <code>git describe</code> output in general is</p><pre><code class="language-none">`&quot;TAGNAME-[NUMBER_OF_COMMITS_AHEAD-]gLATEST_COMMIT_HASH[_dirty]&quot;`</code></pre><p>If the latest tag is <code>v1.2.3</code> and there are 5 additional commits while the latest commit hash is 334a0f225d9fba86161ab4c8892d4f023688159c, the output will be <code>v1.2.3-5-g334a0f</code>. Notice that git will shorten the hash if there are no ambiguous commits.</p><p>More information about the <code>git describe</code> output can be found on (https://git-scm.com/docs/git-describe)</p><p>See also <a href="#DrWatson.tag!"><code>tag!</code></a>.</p><p><strong>Examples</strong></p><pre><code class="language-julia">julia&gt; gitdescribe() # a tag exists
&quot;v1.2.3-g7364ab&quot;

julia&gt; gitdescribe() # a tag doesn&#39;t exist
&quot;96df587e45b29e7a46348a3d780db1f85f41de04&quot;

julia&gt; gitdescribe(path_to_a_dirty_repo)
&quot;3bf684c6a115e3dce484b7f200b66d3ced8b0832_dirty&quot;</code></pre></div></div><a class="source-link" target="_blank" href="https://github.com/JuliaDynamics/DrWatson.jl/blob/5693e6caa22fad1d0193ea560b33b1cabef2d8a4/src/saving_tools.jl#L4-L41">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DrWatson.gitpatch" href="#DrWatson.gitpatch"><code>DrWatson.gitpatch</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">gitpatch(gitpath = projectdir())</code></pre><p>Generates a patch describing the changes of a dirty repository compared to its last commit; i.e. what <code>git diff HEAD</code> produces. The <code>gitpath</code> needs to point to a directory within a git repository, otherwise <code>nothing</code> is returned.</p></div></div><a class="source-link" target="_blank" href="https://github.com/JuliaDynamics/DrWatson.jl/blob/5693e6caa22fad1d0193ea560b33b1cabef2d8a4/src/saving_tools.jl#L69-L76">source</a></section><p>Please notice that <code>tag!</code> will operate in place only when possible. If not possible then a new dictionary is returned. Also (importantly) these functions will <strong>never error</strong> as they are most commonly used when saving simulations and this could risk data not being saved!</p><h2><a class="nav-anchor" id="Produce-or-Load-1" href="#Produce-or-Load-1">Produce or Load</a></h2><p><code>produce_or_load</code> is a function that very conveniently integrates with <a href="../name/#DrWatson.savename"><code>savename</code></a> to either load a file if it exists, or if it doesn&#39;t to produce it, save it and then return it!</p><p>This saves you the effort of checking if a file exists and then loading, or then running some code and saving, or writing a bunch of <code>if</code> clauses in your code. In addition, it attempts to minimize computing energy spent on getting a result.</p><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DrWatson.produce_or_load" href="#DrWatson.produce_or_load"><code>DrWatson.produce_or_load</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">produce_or_load([path=&quot;&quot;,] c, f; kwargs...) -&gt; file, s</code></pre><p>Let <code>s = joinpath(path, savename(prefix, c, suffix))</code>. If a file named <code>s</code> exists then load it and return it, along with the global path that it is saved at (<code>s</code>).</p><p>If the file does not exist then call <code>file = f(c)</code>, with <code>f</code> your function that produces your data. Then save <code>file</code> as <code>s</code> and then return <code>file, s</code>. The function <code>f</code> must return a dictionary, the macros <a href="../name/#DrWatson.@dict"><code>@dict</code></a> and <a href="../name/#DrWatson.@strdict"><code>@strdict</code></a> can help with that.</p><p><strong>Keywords</strong></p><ul><li><code>tag = true</code> : Save the file using <a href="#DrWatson.tagsave"><code>tagsave</code></a>.</li><li><code>gitpath = projectdir()</code> : Path to search for a Git repo.</li><li><code>suffix = &quot;bson&quot;, prefix = default_prefix(c)</code> : Used in <code>savename</code>.</li><li><code>force = false</code> : If <code>true</code> then don&#39;t check if file <code>s</code> exists and produce it and save it anyway.</li><li><code>loadfile = true</code> : If <code>false</code>, this function does not actually load the file, but only checks if it exists. The return value in this case is always <code>nothing, s</code>, regardless of whether the file exists or not. If it doesn&#39;t exist it is still produced and saved.</li><li><code>verbose = true</code> : print info about the process, if the file doesn&#39;t exist.</li><li><code>kwargs...</code> : All other keywords are propagated to <code>savename</code>.</li></ul><p>See also <a href="../name/#DrWatson.savename"><code>savename</code></a>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/JuliaDynamics/DrWatson.jl/blob/5693e6caa22fad1d0193ea560b33b1cabef2d8a4/src/saving_files.jl#L3-L28">source</a></section><p>See <a href="../real_world/#Stopping-&quot;Did-I-run-this?&quot;-1">Stopping &quot;Did I run this?&quot;</a> for an example usage of <code>produce_or_load</code>.</p><footer><hr/><a class="previous" href="../name/"><span class="direction">Previous</span><span class="title">Naming Simulations</span></a><a class="next" href="../run&amp;list/"><span class="direction">Next</span><span class="title">Running &amp; Listing Simulations</span></a></footer></article></body></html>
